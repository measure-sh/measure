# build stage
FROM --platform=$BUILDPLATFORM public.ecr.aws/docker/library/golang:alpine AS builder
ARG TARGETOS
ARG TARGETARCH
WORKDIR /go/src

# Copy dependency modules first for caching
COPY email/go.mod email/go.sum ./email/
COPY alerts/go.mod alerts/go.sum ./alerts/
RUN cd alerts && go mod download

# Copy source
COPY email/ ./email/
COPY alerts/ ./alerts/

RUN --mount=type=cache,target=/go/pkg/mod \
  --mount=type=cache,target=/root/.cache/go-build \
  cd alerts && GOOS=${TARGETOS} GOARCH=${TARGETARCH} go build -o /go/bin/app -v .

# final stage
FROM public.ecr.aws/docker/library/alpine:latest
RUN apk --no-cache add ca-certificates
COPY --from=builder /go/bin/app /app
ENTRYPOINT ["/app"]
EXPOSE 8082
