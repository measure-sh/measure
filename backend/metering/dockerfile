# build stage
FROM --platform=$BUILDPLATFORM public.ecr.aws/docker/library/golang:alpine AS builder
ARG TARGETOS
ARG TARGETARCH
WORKDIR /go/src

# Copy dependency modules first for caching
COPY email/go.mod email/go.sum ./email/
COPY billing/go.mod billing/go.sum ./billing/
COPY metering/go.mod metering/go.sum ./metering/
RUN cd metering && go mod download

# Copy source
COPY email/ ./email/
COPY billing/ ./billing/
COPY metering/ ./metering/

RUN --mount=type=cache,target=/go/pkg/mod \
  --mount=type=cache,target=/root/.cache/go-build \
  cd metering && GOOS=${TARGETOS} GOARCH=${TARGETARCH} go build -o /go/bin/app -v .

# final stage
FROM public.ecr.aws/docker/library/alpine:latest
RUN apk --no-cache add ca-certificates
COPY --from=builder /go/bin/app /app
ENTRYPOINT ["/app"]
EXPOSE 8084
